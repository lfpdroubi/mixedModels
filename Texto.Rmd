---
title: "Modelos mistos na Engenharia de Avaliações"
subtitle: "Possibilidades e aplicações"
author: 
  - Luiz F. P. Droubi^[Engenheiro Civil e Cientista de Dados. Especialista em Auditoria, Avaliações e Perícias de Engenharia pelo IPOG. É mestrando em Gestão Territorial pela Universidade Federal de Santa Catarina (UFSC). É pesquisador  no Grupo de Engenharia de Avaliações e Perícias (GEAP-UFSC), lfpdroubi@gmail.com]
  - Carlos Augusto Zilli^[Engenheiro Civil, Engenheiro de Segurança do Trabalho e Matemático. É especialista em Gestão de Obras e Projetos pela Universidade do Sul de Santa Catarina (UNISUL). É mestre em Gestão Territorial pela Universidade Federal de Santa Catarina (UFSC). É docente no Instituto Federal de Santa Catarina (IFSC) e pesquisador do Grupo de Engenharia de Avaliações e Perícias (GEAP), carlos.zilli@ifsc.edu.br]
  - Norberto Hochheim^[Professor Titular do Departamento de Engenharia Civil da Universidade Federal de Santa Catarina (UFSC), é Engenheiro Civil e Mestre em Engenharia de Produção e Sistemas pela UFSC, Doutor pela Université de Nancy (França). Ministra disciplinas em cursos de graduação, especialização, mestrado e doutorado, entre elas *Engenharia de Avaliações*, *Planejamento Econômico e Financeiro* e *PVGs*, hochheim@gmail.com]
date: "`r format(Sys.Date(), '%d/%m/%Y')`"
output:
  pdf_document:
    includes:
      in_header: preamble.tex
    keep_tex: yes
    latex_engine: xelatex
    number_sections: yes
    toc: no
  word_document: default
  html_document:
    fig_caption: yes
    keep_md: yes
classoption: a4paper, 11pt
documentclass: article
geometry: left=2.5cm,right=2.5cm,top=3cm,bottom=2.5cm
link-citations: yes
linkcolor: red
urlcolor: magenta
citecolor: green
csl: ABNT_UFPR_2011-Mendeley.csl
bibliography: bibliography.bib
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.path = "images/", out.width = "70%",
                      dev = "CairoPNG", dpi = 600, fig.align = "center",
                      fig.pos = "H", warning = FALSE, message = FALSE)
type <- knitr::opts_knit$get("rmarkdown.pandoc.to")
library(lme4)
library(merTools)
library(tibble)
library(ggplot2)
library(cowplot)
theme_set(theme_cowplot(12))
library(stargazer)
library(sjmisc)
library(lattice)
library(knitr)
library(kableExtra)
library(broom)
library(appraiseR)
```

# Resumo {-}

Este trabalho visa a introdução aos modelos mistos ou hierárquicos, com foco
para a aplicação na Engenharia de Avaliações. A modelagem de efeitos mistos pode
ser bastante útil na Engenharia de Avaliações quando há presença de
heterogeneidade amostral, especialmente no contexto da ocorrência de ausência de
dados em número suficiente para uma determinada característica, situação em que
a estimação por modelos mistos é mais eficiente. Além disto, com a modelagem 
hierárquica se abre um campo muito interessante para a análise do impacto da
presença de amenidades sobre os valores dos imóveis, possivelmente até embasando
a realização de investimentos em infraestrutura e/ou intervenções urbanas com 
fins de valorização dos imóveis, visando a recuperação das mais-valias. 
Finalmente, os modelos mistos possuem grande aplicação para a análise de dados
em séries temporais ou em painel, o que indica um grande potencial de aplicação
destes modelos para a confecção de índices de preços de imóveis.

# Introdução

Na Engenharia de Avaliações, assim como em diversos ramos das ciências sociais,
a abordagem padrão para lidar com a heterogeneidade amostral é a modelagem com
efeitos fixos. Este tipo de abordagem permite a segregação dos dados da amostra
em diferentes agrupamentos, através da utilização de variáveis *dummies*[^1] que
indicam a que agrupamento pertence cada dado amostral.

Como será visto, no entanto, este tipo de modelagem elimina a possibilidade de
*explicar* a variância *entre* os diversos grupos de dados. Na Engenharia de 
Avaliações, quando o objetivo é a previsão de valores de um imóvel em específico, 
isto  não acarreta em nenhum problema, a não ser que existam poucos dados nos 
agrupamentos, o que acaba por prejudicar a estimação.

No entanto, quando o objetivo é a explicação do mercado, a modelagem por efeitos
fixos deixa a desejar: o máximo que se pode obter de um modelo de efeitos fixos
é a magnitude do efeito da localização em um determinado agrupamento [^2]. Nada 
que possa explicar o contexto pode ser incluído na análise, já que toda a 
variância no nível dos agrupamentos é absorvida pelas *dummies*.

Nos modelos mistos, além dos efeitos fixos ligados à explicação do valor dos
imóveis, tais como área, número de quartos e/ou banheiros, e outros, efeitos
aleatórios são utilizados para lidar com a heterogeneidade da amostra, seja 
devido ao contexto, seja devido ao tempo, já que os modelos mistos possuem 
grande aplicação na modelagem de dados em painel ou séries temporais.

O objetivo deste trabalho é a apresentação dos modelos mistos e suas 
possibilidades de aplicação na Engenharia de Avaliações. No caso da modelagem de 
dados em seção transversal (corte), será mostrado como os modelos mistos podem
ser úteis na elaboração de plantas de valores genéricos. Além disto, será 
discutido brevemente a aplicação dos modelos mistos para dados em painel, o que
pode ser útil, na Engenharia de Avaliaçãoes, na construção de índices de preços
de imóveis.

[^1]: Ou variáveis dicotômicas em grupo. Neste trabalho estas variáveis serão 
tratadas simplesmente pelo termo em inglês *dummies*.

[^2]: Plümper e Troeger (2007) propuseram efetuar a decomposição vetorial do
modelo de efeitos fixos para a modelagem de níveis mais altos, porém este método
foi fortemente criticado por sua imprecisão no cálculo dos erros-padrão e ainda
possui as desvantagens de não ser possível a estimação de níveis superiores a 2 
e de requerer a estimação em diferentes estágios [@bell2015, 140-141].

# Revisão Bibliográfica

Os modelos de efeitos fixos são uma espécie de "padrão ouro" em diversos ramos
da ciência para lidar com a heterogeneidade amostral. No entanto, de acordo com
Bell *et al.* [-@bell2019, 1052], os modelos mistos bem especificados oferecem
uma abordagem muito mais completa destes tipos de dados do que a modelagem por
efeitos fixos.

Segundo Bell *et al.* [-@bell2019, 1051], existe uma confusão na literatura a
respeito dos modelos mistos, no que tange à aglutinação em uma modelagem de
diversos tipos de efeitos, fixos e aleatórios, sendo que os modelos mistos mais
complexos tem sido chamados, erroneamente, de modelos híbridos.

Os modelos mistos também podem ser confundidos com modelos multiníveis ou
hierárquicos, uma vez que estes últimos são um caso particular dos primeiros,
*i.e* os modelos hierárquicos são modelos mistos em que os dados se apresentam
de maneira aninhada (imóveis se agrupam em bairros, que por sua vez se agrupam
em regiões e assim por diante), o que possibilita a sua modelagem de maneira
hierárquica. No entanto, se os dados se agrupam em diferentes grupamentos
independentes, não aninhados, a modelagem hierárquica não se aplica, porém estes
tipos de dados podem também ser modelados pelos modelos mistos. Em suma, todo
modelo hierárquico é um modelo misto, mas o inverso não se aplica [@Bates].

## Modelagem por efeitos fixos

A modelagem por efeitos fixos é frequentemente aplicada na Engenharia de 
Avaliações, assim como em diversas outras áreas da ciência [@bell2019, 1057], 
apesar desta terminologia não ser sempre empregada.

Um modelo de efeitos fixos nada mais é do que um modelo em que a heterogeneidade 
da amostra é resolvida através da inclusão de variáveis *dummies*
representando cada agrupamento de dados. Após a inclusão destas variáveis, a estimação é feita pelo métodos dos mínimos quadrados ordinários.

A modelagem por efeitos fixos pode ser escrita conforme a equação \ref{eq:fixef},
onde a variância entre os agrupamentos de dados (variância de nível mais alto)
é modelada através de variáveis *dummies* $D_j$ [@bell2015, 138]:

\begin{equation} \label{eq:fixef}
y_{ij} = \sum_{j=1}^{j}\beta_{0j}D_j + \beta_1 x_{ij} + \varepsilon_{ij}
\end{equation}

Onde $y_{ij}$ é a variável resposta, $i$ e $j$ se referem aos dois níveis de análise, com $i$ representando o nível dos indivíduos e $j$ o nível dos agrupamentos, $x_{ij}$ é uma (podem haver mais) variável explicativa com características variantes entre os indíviduos da amostra e $\varepsilon_{ij}$ é 
um termo de erro, que são assumidos independentes e identicamente distribuídos (i.i.d), com distribuição supostamente normal, média zero e desvio-padrão $\sigma_{\varepsilon}^2$. 

No entanto, uma outra maneira mais conveniente de escrever a formulação de 
efeitos fixos, para a comparação que se pretende, equivalente à
primeira, pode ser vista na equação \ref{eq:fixef2} [@bell2019, 1058]:

\begin{equation} \label{eq:fixef2}
y_{ij} = \beta_1 (x_{ij} - \bar{x}_j) + (\upsilon_j + \varepsilon_{ij}) 
\end{equation}

Onde $\upsilon_j$ é um termo discreto para cada agrupamento de dados[^3]. 

[^3]: O termo $\upsilon_j$ é o intercepto de cada agrupamento, quando se 
ajusta um modelo sem intercepto.

Na prática, no entanto, a formulação acima raramente é utilizada, pois
perde-se um grau de liberdade na estimação de um intercepto para cada
bairro, quando se pode utilizar um nível de referência e estimar apenas
a diferença entre os níveis de cada agrupamento em relação a este nível
de referência, como ilustrado na equação \ref{eq:fixef3} [@bell2019, 1058]:

\begin{equation} \label{eq:fixef3}
(y_{ij} - \bar{y}_i) = \beta_1 (x_{ij} - \bar{x}_j) + (\varepsilon_{ij}) 
\end{equation}

## Modelagem por efeitos mistos

Existem diversas formas de se utilizar os modelos mistos. Neste trabalho 
apresentam-se diversas possibilidades, desde a abordagem mais simples, que 
possibilita uma melhor comparação com o modelo de efeitos fixos, muito conhecido 
na Engenharia de Avaliações, até a abordagem mais complexa, a formulação REWB
(Random Effects Within-Between).

### Modelo de efeitos mistos simples

A modelagem por efeitos mistos considera, além dos efeitos fixos, um
termo de efeitos aleatórios [@bell2019, 1059]. Uma das maneiras de
escrever a formulação de efeitos mistos pode ser vista na equação
\ref{eq:mixef}.

\begin{equation} \label{eq:mixef}
y_{ij} = \beta_0 + \beta_1^{RE} x_{ij} + \beta_2 z_j + (\upsilon_j + \varepsilon_{ij}) 
\end{equation}

No caso da equação \ref{eq:mixef}, o termo $\upsilon_j$ é um termo
estocástico de efeitos aleatórios para os agrupamentos, suposto
normalmente distribuído e com média zero, ou seja
$\upsilon_j \sim N(0, \sigma_{\upsilon}^2)$ [@bell2019, 1055]. A variável $x_{ij}$
é uma variável de nível 1, variante entre os indivíduos e a variável $z_j$ é uma 
variável de nível 2, variante entre os agrupamentos, *i.e.* a variável $z_j$
não é uma variável hedônica dos imóveis, mas uma variável que representa todo um
grupo de imóveis [^4]. 

[^4]: É possível utilizar os modelos mistos sem a utilização de qualquer variável 
de segundo nível, obtendo-se um modelo de interceptos aleatórios.

Neste tipo de modelagem estimam-se, além dos coeficientes das 
variáveis de nível mais baixo, $\beta_0$ e $\beta_1$, o(s) coeficiente(s) da(s) 
variável(eis) de segundo nível $\beta_2$ e os parâmetros $\sigma_\varepsilon^2$ 
e $\sigma_\upsilon^2$, ou seja, as variâncias de primeiro e segundo nível, 
respectivamente.

A diferença de nível entre as variáveis pode ser melhor compreendida ao
se dividir a modelagem em dois níveis (modelagem hierárquica), como pode ser 
visto nas equações \ref{eq:micro} e \ref{eq:macro}:

\begin{equation} \label{eq:micro}
y_{ij} = \beta_{0j} + \beta_1^{RE} x_{ij} + \varepsilon_{ij} 
\end{equation}

\begin{equation} \label{eq:macro}
\beta_{0j} = \beta_0 + \beta_2 z_{j} + \upsilon_{j} 
\end{equation}

Segundo Bell e Jones [-@bell2015, 135-136], a equação \ref{eq:micro} é chamada 
de parte micro, enquanto a equação \ref{eq:macro} é chamada de parte macro da 
formulação de efeitos mistos, que são estimadas em conjunto ao substituir 
\ref{eq:macro} em \ref{eq:micro} para se obter o modelo misto da equação 
\ref{eq:mixef}.

Em suma, para Bell *et al.* [-@bell2019, 1061], a grande diferença
entre a formulação de efeitos fixos e a formulação de efeitos mistos
está na maneira como as modelagens tratam os agrupamentos de dados, se
de maneira discreta (efeitos fixos) ou de maneira aleatória (efeitos
aleatórios). Enquanto na modelagem de efeitos fixos são adicionadas
variáveis *dummies* discretas para a modelagem dos diferentes
agrupamentos, na modelagem de efeitos aleatórios é considerado que a
diferença entre os dados de diferentes agrupamentos pode ser modelada
por uma variável aleatória normal.

Enquanto nos modelos mistos a variância é dividida em duas partes, uma ao nível 
dos indivíduos e outra ao nível dos agrupamentos, nos modelos de efeitos fixos 
a variância entre os agrupamentos é totalmente absorvida pelas variáveis 
*dummies*, que consomem todos os graus de liberdade do segundo nível hierárquico, 
eliminando dessa forma qualquer possibilidade de introdução de variáveis 
como $z_j$, na equação \ref{eq:mixef} [@bell2015, 139].

Segundo os autores citados, ainda, esta visão não é unânime: na
econometria, por exemplo, é considerado que a diferença fundamental
entre as modelagens de efeitos fixos e efeitos mistos está de fato na
hipótese considerada pelos modelos mistos de que não há correlação dos
efeitos aleatórios (representados por $\upsilon_i$) e os regressores
($x_ij$), o que é permitido na modelagem de efeitos fixos [@bell2019, 1060].

Deve-se notar ainda que os modelos mistos, tal como apresentados na equação
\ref{eq:mixef}, ainda podem ser facilmente estendidos para incorporar outros
níveis hierárquicos mais altos, ou ainda a variabilidade não apenas para os
interceptos, mas também para os coeficientes das variáveis explicativas, com o
consumo de apenas mais um grau de liberdade, como pode ser visto na equação
\ref{eq:mixef2}, onde além do termo aleatório relacionado aos interceptos é
adicionado outro termo aleatório, $\gamma_j \sim N(0, \sigma^2_\gamma)$, 
relacionado às inclinações, formando assim um modelo de interceptos e 
inclinações aleatórias [@bell2019, 1052]:

\begin{equation} \label{eq:mixef2}
y_{ij} = (\beta_0 + \upsilon_j) + (\beta_1 + \gamma_j) x_{ij} + \beta_2 z_j + \varepsilon_{ij}
\end{equation}

Na modelagem por efeitos fixos seriam necessárias a inclusão de diversos termos
de interação para a modelagem de uma inclinação diferente para cada agrupamento,
gerando um modelo cuja estimação é extremamente custosa em termos de graus de
liberdade.

### Formulação de Mundlak

Esta formulação consiste da introdução de um termo adicional à parte macro do 
modelo, que leva em conta a variação *entre* os grupos (*between effect*), de 
maneira que a equação \ref{eq:macro} torna-se:

\begin{equation} \label{eq:macro2}
\beta_{0j} = \beta_0 + \beta_2 z_{j} + \beta_3 \bar{x}_j + \upsilon_{j} 
\end{equation}

A combinação das equações \ref{eq:micro} e \ref{eq:macro2} toma a forma da 
equação \ref{eq:mundlak}, que é conhecida na literatura como formulação de
Mundlak [@bell2015, 1055]:

\begin{equation} \label{eq:mundlak}
y_{ij} = \beta_0 + \beta_{1} x_{ij} + \beta_{3}\bar{x}_j+ \beta_2 z_j + (\upsilon_j + \varepsilon_{ij}) 
\end{equation}

Segundo Bell *et al.* [-@bell2019, 1055], na formulação de Mundlak o efeito
contextual, representado na equação \ref{eq:mundlak} pelo termo $\beta_{3}$
(algumas vezes escrito como $\beta_{C}$), é de interesse, pois mostra a
*diferença* entre os efeitos *dentro* (*within effect*) e *entre* (*between
effect*) os grupos.

Na prática, os modelos de Mundlak e os modelos de efeitos fixos estimarão 
exatamente os mesmos valores para os coeficientes de efeitos dentro dos 
agrupamentos (*within effects*), representado na formulação acima pelo termo 
$\beta_1$, algumas vezes escrito $\beta_{W}$ [@bell2019, 1057]. 

Esta formulação, segundo Bell *et al.* [-@bell2019, 1056], é particularmente 
interessante para a análise de dados em seção transversal, pois o coeficiente
$\beta_C$ representa o efeito da mundança de grupo de um indivíduo, mantidas as
suas características. 

Na Engenharia de  Avaliações, por exemplo, o valor de $\beta_C$ pode representar
qual é a influência de uma característica no valor de um lote-padrão, quando
este lote-padrão muda de um bairro ou zona para outro, o que é particularmente
interessante para a confecção de planta de valores genéricos. Por exemplo, 
imagine-se que se esteja tratando da variável área do lote: enquanto $\beta_W$
representa o efeito da mudança de área de um imóvel dentro dos agrupamentos,
$\beta_C$ representará o efeito da mudança da área média do agrupamento sobre o
valor do lote, ou seja, qual o efeito do contexto sobre o valor do lote. 

### Formulação Within-Between

Uma maneira às vezes mais adequada de escrever a formulação de modelos mistos
consiste na separação total dos efeitos dentro dos agrupamentos dos efeitos
entre os agrupamentos, o que é conhecido na literatura por formulação
*within-between*. Esta formulação é a mais genérica, capaz de modelar diversos
efeitos separadamente e é particularmente interessante na análise de dados em
painéis ou séries temporais, dada a sua melhor interpretabilidade para estes
tipos de dados [@bell2015, 143].

Partindo da formulação de Mundlak, os efeitos *within* e *between* podem ter
seus efeitos totalmente separados pela divisão do coeficiente $\beta_3$ da 
equação \ref{eq:mundlak}, escrevendo-o explicitamente como uma diferença em 
relação ao coeficiente $\beta_1$, conforme mostrado pela equação \ref{eq:rewb1}

\begin{equation} \label{eq:rewb1}
y_{ij} = \beta_0 + \beta_1 x_{ij} + (\beta_{4} - \beta_1) \bar{x}_j+ \beta_2 z_j + (\upsilon_j + \varepsilon_{it}) 
\end{equation}

Rearranjando conveniente a equação \ref{eq:rewb1}, chega-se à formulação REWB, 
como mostra a equação \ref{eq:rewb2}:

\begin{equation} \label{eq:rewb1}
y_{ij} = \beta_0 + \beta_1 (x_{ij} - \bar{x}_j) + \beta_4 \bar{x}_j+ \beta_2 z_j + (\upsilon_j + \varepsilon_{it}) 
\end{equation}

Mais uma vez é possível, ainda, a adição de inclinações aleatórias nesta 
formulação, obtendo-se assim a formulação mais genérica possível, como pode ser
visto na equação \ref{eq:rewb2}:

\begin{equation} \label{eq:rewb2}
y_{ij} = \mu + \beta_{W} (x_{ij} - \bar{x}_j) + \beta_{B}\bar{x}_j+ 
\beta_2 z_j + \upsilon_{j0} + \upsilon_{j1} (x_{ij} - \bar{x}_j) + \varepsilon_{ij0} 
\end{equation}

Onde o termo $\upsilon_{j0}$ está relacionado à aleatoriedade do intercepto e o
termo $\upsilon_{j1}$ está relacionado à aleatoriedade do coeficiente da
variável $x$.

## Considerações sobre a pertinência de cada modelagem

Segundo Bell e Jones [-@bell2015, 143], um modelo de efeitos fixos pode ser
visto como uma forma de modelo de efeitos mistos onde a variância nos níveis
mais altos é restringida a infinito. Desta maneira, para Bell e Jones
[-@bell2015], os modelos de efeitos mistos são muito mais interessantes do que
os modelos de efeitos fixos, já que além de propiciarem todas as informações que
os modelos de efeitos fixos propiciam, eles ainda tem possibilidade de ir além e
fornecer outras informações que os modelos de efeitos fixos não fornecem, como a
separação dos efeitos de uma variável *entre*  os agrupamentos e *dentro* dos
agrupramentos. Para Bell *et al.* [-@bell2019, 1060], para o efeito *dentro* dos
agrupamentos, os resultados estimados pela formulação REWB ou pela formulação de
Mundlak serão rigorosamente os mesmos obtidos pelo modelo de efeitos fixos. No
entanto, enquanto os modelos de REWB e de Mundlak fornecem informações a
respeito dos efeitos *entre* os agrupamentos, os modelos de efeitos fixos não
são capazes de fornecer qualquer informação a este respeito, já que a variância
de nível mais alto foi restringida.

Deve ser feita uma distinção também entre os objetivos da modelagem: na 
Engenharia de Avaliações, se o objetivo for determinar o valor de um imóvel em
específico a partir de uma amostra heterogênea, sem a pretensão de explicar a
diferença de valores entre os diversos agrupamentos, a formulação de efeitos
fixos é suficiente, exceto no caso de não haver dados suficientes para uma boa
estimação dentro de cada agrupamento. Já quando o objetivo é a obtenção do valor
de um imóvel padrão em diferentes agrupamentos, como na elaboração de uma PVG, 
a modelagem por efeitos mistos é a mais adequada, especialmente se não se dispõe
de dados disponíveis para os diferentes agrupamentos, mas apenas para uma parte
(representativa) deles, caso em que a adição de variáveis de nível mais alto
podem ser utilizadas para a previsão de valores nos agrupamentos não-amostrados.

Deve ser observado também que a hipótese de modelar os diversos agrupamentos
como uma variável aleatória é razoável apenas quando o número de agrupamentos
for grande o suficiente. Para poucos agrupamentos, a modelagem por efeitos fixos
ainda parece ser mais adequada [ver @bell2019, 1071].

Também deve ser observado, ainda, que a utilização da formulação simples para
modelos mistos, como a da equação \ref{eq:mixef}, como muitas vezes se encontra
na prática [ver @polonia], não é tão interessante como a aplicação das
modelagens REWB e de Mundlak. No entanto, a aplicação da formulação REWB e de
Mundlak só faz sentido se houver efetivamente uma diferença entre os efeitos
dentro e entre os agrupamentos. Caso $\beta_{1W} = \beta_{2B}$ (REWB) ou
$\beta_{2C} = 0$ (Mundlak), não faz sentido utilizar estas formulações e a
formulação simples de efeitos mistos (equação \ref{eq:mixef}) deve ser a adotada
[@bell2019, 1058].

## Estimação em modelos mistos

Existem diversas formas de estimação para os modelos mistos. Segundo Jones e 
Bullen [-@jones1994, 258], até meados da década de 80 a falta de algoritmos de 
estimação gerais limitava severamente a aplicação da modelagem multinível. 
Durante a década de 80, contudo, três algoritmos tornaram-se disponíveis, sendo 
os mais importantes o procedimento de Goldstein [-@goldstein], que consistia na 
estimação dos mínimos quadrados generalizados de maneira iterativa e um 
algoritmo denominado Fischer-scoring [@longford]. 

Mais recentemente, a estimação através da penalização de mínimos quadrados 
ponderados tem se mostrado superior em termos computacioanis [@Bates3; @Bates2].

Os detalhes da implementação estão além do escopo deste artigo e podem ser 
vistos em Bates [-@Bates2].

Segundo Clark [-@clark2019shrinkage], uma das características mais fortes da
estimação em modelos mistos está relacionada ao encolhimento, ou seja, a
suposição da normalidade dos efeitos aleatórios tem o efeito de penalizar mais
as observações mais discrepantes, fazendo com que os interceptos e coeficientes
previstos se encolham em direção aos valores médios.

Isto é particularmente interessante no caso da presença de agrupamentos com
pequeno número de dados: enquanto nos modelos de efeitos fixos os valores dos
coeficientes e interceptos se superajustam a estes poucos dados, gerando valores
extremos, nos modelos de efeitos mistos, os agrupamentos com menos dados e
valores potencialmente mais extremos, tem os valores dos coeficientes e
interceptos encolhidos em relação à média. É comum se referir a este efeito como
um "empréstimo de força", *i.e.* a previsão nos agrupamentos de menor número de
dados é fortalecida pelo "empréstimo" de dados de outros agrupamentos 
[@jones1994, 260].

# Estudo de Caso

Para o estudo de caso foi utilizada a implementação do pacote \pkg{lme4} [@Bates]
no \proglang{R}, versão 4.0.2 [@R].

## Criação de dados via simulação

```{r}
# Simulação de dados
seed <- 1
set.seed(seed)
# Dados por bairro
a <- 50
# Número de bairros
b <- 10
# Variáveis de nível 1
#
# Área
#
A <- rnorm(a*b, mean = 400, sd = 50) + c(rep(seq(0, 100, 25), each = a), rep(seq(100, 0, -25), each = a))
#
# Variáveis de nível 2
#
# Área livre
Av <- rep(seq(.2, .65, .05), each = a)
#
```

```{r}
dados <- tibble(Area = A,
                AreaVerde = rep(seq(.2, .65, .05) + rnorm(10, 0, .025), each = a),
                Bairro = factor(rep(LETTERS[1:b], each=a))
                )
dados <- as_tibble(dados)
dados <- de_mean(dados, "Area", grp = "Bairro")
dados$Area_center <- as.numeric(scale(dados$Area, center = 400, scale = FALSE))
#
# Equação de segundo nível
#
beta_zero <- 2500
beta_zeroj <- beta_zero + 4000*Av + 5*dados$Area_gm  + rnorm(b*a, mean = 0, sd = 50)
#
# Equação mista
#
dados$ValorUnitario <- beta_zeroj - 3*dados$Area + rnorm(b*a, mean = 0, sd = 100)
#
#
bairroH <- which(dados$Bairro == "H")
newdata <- dados[bairroH, ]
amostra <- dados[setdiff(1:550, bairroH), ]
```

Foram criados `r a*b` dados de lotes, divididos igualmente em `r b` bairros, 
a partir de simulação com o auxílio do software **R**.

Os dados foram criados conforme a equação abaixo \ref{eq:EC1} e \ref{eq:EC2}, abaixo:

\begin{align}
ValorUnitario &= \beta_{0j} - 3,0 \cdot Area + \varepsilon_{ij}  \label{eq:EC1}\\
\beta_{0j} &= \beta_0 + 4000 \cdot A_{Vj} + 5,0 \cdot \overline{Area_j} + \upsilon_j \label{eq:EC2}
\end{align}

Onde:

1. $Area$ são as áreas dos lotes;
2. $A_{Vj}$ é uma variável de nível 2 que representa a porcentagem de
áreas verdes em cada bairro, em relação à área total;
3. $\overline{Area_j}$ é a área média dos lotes em cada bairro;
4. $\varepsilon_{ij}$ é o termo de erro no primeiro nível de análise;
5. $\upsilon_j$ é o termo de erro no segundo nível de análise.

Os parâmetros adotados para cada variável podem ser vistos na tabela 1:

| Variável                       | Tipo          | Distribuição | Parâmetros                          | Obs.                      |
|:-------------------------------|--------------:|:------------:|------------------------------------:|:-------------------------:|
| Área do lote ($Area$)          | Quantitativa  | Normal       | $\mu = 400 \ a \ 500, \sigma = 50$  |  -                        |
| Área média ($\overline{Area}$) | Quantitativa  | Discreta     | $\sim 400 \ a \ 500$                | De 25 em 25               |
| Bairro                         | Qualitativa   | -            | A a J                               |  -                        |
| Áreas Verdes ($A_V$)           | Quantitativa  | Uniforme     | $\mu = 0,2 \ a \ 0,65$              | De 0,05 em 0,05           |
| $\beta_{0}$                    | Coeficiente   | Discreta     | 3000                                |  -                        |
| $\upsilon$                     | Erro          | Normal       | $\mu = 0, \sigma_\upsilon = 50$     |  -                        |
| $\varepsilon$                  | Erro          | Normal       | $\mu = 0, \sigma_\varepsilon = 100$ |  -                        |
Table: Parâmetros utilizados para simulação dos dados.

## Análise exploratória dos dados


```{r}
p1 <- ggplot(dados, aes(x = Bairro, y = ValorUnitario, color = Bairro)) +
        geom_boxplot() + 
        geom_smooth(method = "lm", se = FALSE)
```

```{r}
p2 <- ggplot(dados, aes(x = Area, y = ValorUnitario, color = Bairro)) +
        geom_point() + 
        geom_smooth(method = "lm", se = FALSE)
```

```{r}
ddd <- data.frame(Bairro = unique(dados$Bairro), AreaVerde = unique(dados$AreaVerde))
p3 <- ggplot(ddd, aes(x = Bairro, y = AreaVerde, fill = Bairro)) +
        geom_bar(stat = "identity")
```

```{r}
p4 <- ggplot(dados, aes(ValorUnitario, fill = Bairro)) + 
  geom_density(alpha = 0.5) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05))) +
  theme_minimal_hgrid(12)
```

Na figura \ref{fig:exploratoria} é possível ver os principais gráficos dos dados
gerados.

```{r exploratoria, fig.cap = "Análise exploratória dos dados.", out.width="100%"}
plot_grid(p1 + theme(legend.position="none"), 
          p2 + theme(legend.position="none"),
          p3 + theme(legend.position="none"),
          p4 + theme(legend.position="none"), 
          labels = "AUTO", 
          label_size = 12)
```

## Ajuste de modelos

Com os dados gerados foram ajustados um modelo de efeitos fixos e três
modelos mistos: um modelo misto simples, que praticamente equivale ao
modelo de efeitos fixos, um modelo misto com a adição de uma variável de
segundo nível e um modelo misto utilizando-se a formulação de Mundlak.

Para o ajuste do modelo de efeitos fixos foram utilizados todos os dados
gerados, pois não há como prever valores para bairros não contemplados
na amostra em um modelo deste tipo.

### Modelo de efeitos fixos

Com os dados gerados, foi elaborado um modelo de efeitos fixos sem
intercepto, apenas para que fique claro o valor do intercepto aleatório
de cada bairro. Para dar interpretação a estes interceptos aleatórios, a
variável $Area$ foi centralizada em relação à área de um lote-padrão,
considerado de 400 $m^2$, desta maneira o valor do intercepto de cada bairro
é igual ao valor do lote-padrão para este bairro[^5].

[^5]: A centralização de variáveis aqui presente não pretende nenhuma separação 
entre efeitos \emph{within} e  \emph{between}, mas apenas possibilitar uma 
interpretação para os valores do coeficientes dos interceptos para cada bairro. 
Ver Droubi *et al.* [-@droubi2019] para mais detalhes sobre este tipo de centralização. 

O modelo é descrito pela equação \ref{eq:fixefEC}:

\begin{equation} \label{eq:fixefEC}
ValorUnitario = \beta_1 (Area - 400) + \beta_{2j}Bairro_j + \varepsilon
\end{equation}

onde $\beta_{2j}$ são os coeficientes das variáveis dicotômicas em grupo 
($Bairro_j$).

```{r}
fit <- lm(ValorUnitario ~ Area_center + Bairro - 1, data = dados)
fit$AIC <- AIC(fit)
fit$BIC <- BIC(fit)
```

### Modelos mistos

Para o ajuste dos modelos mistos foram removidos os 50 dados relativos
ao bairro H, que foram reservados para serem utilizados posteriormente
para validação dos modelos, mostrando como a previsão de valores em
modelos de efeitos mistos pode ser feita para agrupamentos não
contemplados na amostra.

#### Modelo misto simples

Foi elaborado um modelo misto simples, sem separação de efeitos entre e
dentro dos agrupamentos, de acordo com a equação \ref{eq:simples}:

\begin{equation} \label{eq:simples}
ValorUnitario = \beta_0 + \beta_1 (Area - 400) + \upsilon_j + \varepsilon
\end{equation}

Onde $\upsilon_j$ é uma variável aleatória que foi utilizada para
modelar os diferentes bairros.

```{r simpleMixedModel}
fit_lmer <- lmer(ValorUnitario ~ Area_center + (1|Bairro), data = amostra)
s <- summary(fit_lmer)
re <- ranef(fit_lmer)
fe <- fixef(fit_lmer)
pr <- profile(fit_lmer)
```


#### Modelo misto com variável de segundo nível

Foi elaborado um modelo misto simples, porém com a presença de variáveis
de segundo nível hierárquico, como demonstrado na equação \ref{eq:2ndlevel}:

\begin{equation} \label{eq:2ndlevel}
ValorUnitario = \beta_0 + \beta_1 (Area - 400) + \beta_2 A_{Vj}+ \upsilon_j + \varepsilon
\end{equation}

```{r 2ndlevelModel}
fit_lmer2 <- lmer(ValorUnitario ~ Area_center + AreaVerde + (1|Bairro), data = amostra)
s1 <- summary(fit_lmer2)
re1 <- ranef(fit_lmer2)
fe1 <- fixef(fit_lmer2)
pr1 <- profile(fit_lmer2)
```

#### Modelo misto com formulação de Mundlak

Finalmente, foi ajusta um modelo com a formulação de Mundlak. Este
modelo foi elaborado de acordo com a formulação exibida na equação
\ref{eq:ECMundlak}:

\begin{equation} \label{eq:ECMundlak}
ValorUnitario = \beta_0 + \beta_1 Area + \beta_{1C} \overline{Area_j} + \beta_2 A_{Vj} + \upsilon_j + \varepsilon
\end{equation}

```{r mundlakModel}
mundlak <- lmer(ValorUnitario ~ Area + Area_gm + AreaVerde + (1|Bairro), data = amostra)
s2 <- summary(mundlak)
re2 <- ranef(mundlak)
fe2 <- fixef(mundlak)
pr2 <- profile(mundlak)
```

## Resultados

A tabela \ref{tab:fits} mostra as estatísticas básicas dos diversos
modelos mistos (colunas 2, 3 e 4) comparados aos modelo de efeitos
fixos (coluna 1).

```{r, results='asis'}
stargazer(fit, fit_lmer, fit_lmer2, mundlak, header = FALSE, label = "tab:fits", 
          type = type, decimal.mark = ",", digit.separator = ".", digits = 2,
          title = "Comparacão dos modelos de  efeitos fixos e efeitos mistos.",
          intercept.bottom = FALSE, intercept.top = TRUE, report = "vcs*", 
          single.row = TRUE, star.cutoffs = c(0.30, 0.20, 0.10),
          omit.stat = c("rsq", "adj.rsq", "ser","f"), table.placement = "H",
          font.size = "scriptsize",
          covariate.labels = c("Intercepto", "(Area - 400)", paste("Bairro", LETTERS[1:10]), "Area", "Area (contexto)", "Area Verde"))
```

Deve-se notar, primeiramente, que os valores estimados pelo modelo de
efeitos fixos para os interceptos de cada bairro (coluna 1 da tabela
\ref{tab:fits}) são praticamente os mesmos valores obtidos pela
estimação do modelo misto simples, descritos na tabela
\ref{tab:somaitcpt}, onde os valores de referência para cada bairro
foram obtidos através da soma do intercepto global do modelo misto
simples com os interceptos aleatórios do modelo misto simples, que podem
ser visualizados na Figura \ref{fig:dotplot}. A única exceção é o bairro H, que 
foi suprimido da amostra para a confecção do modelo misto.

Como se pode notar na Figura \ref{fig:dotplot}, os valores dos
interceptos aleatórios para cada bairro giram em torno de zero, o seu
valor médio. Como o Bairro H (com $A_V = 0,55$) foi omitido no ajusto
do modelo, não há valores estimados para os efeitos aleatórios para este
bairro.

A única informação a mais que se pode extrair do modelo de efeitos
mistos simples é a componente de variância devido à localidade, separada da
variância ao nível dos imóveis, o que pode ser visto na tabela
\ref{tab:variancias}.

```{r somaitcpt}
kable(t(re$Bairro + fe[1]),
      digits = 1,
      format.args = list(big.mark = ".", decimal.mark = ","),
      caption = "Valores dos interceptos para cada bairro.",
      booktabs = TRUE,
      row.names = FALSE) %>%
  kable_styling(font_size = 10, latex_options = "HOLD_position")
```

```{r variancias}
vc <- VarCorr(fit_lmer)
vc <- as.data.frame(vc)
## both variance and std.dev.
#print(vc,comp=c("Variance","Std.Dev."), digits = 2)
## variance only
#print(vc,comp=c("Variance"))
#as.data.frame(vc)
#as.data.frame(vc,order="lower.tri")
# kable(tidy(fit_lmer, effects = "ran_pars"), digits = 2, 
#       format.args = list(big.mark = ".", decimal.mark = ","),
#       caption = "Efeitos randômicos do modelo misto.", booktabs = T) %>%
#   kable_styling(latex_options = "striped")
kable(vc[, -2:-3], 
      digits = 2,
      format.args = list(big.mark = ".", decimal.mark = ","),
      caption = "Efeitos randômicos do modelo misto.", 
      booktabs = T) %>%
  kable_styling(latex_options = c("striped", "HOLD_position"))
```

```{r dotplot, fig.cap="Efeitos aleatórios do modelo.", results='hide'}
dotplot(ranef(fit_lmer))
```

Pode-se notar que a variância devido à localidade é relevante para o
modelo, haja vista que a variância devido à localidade é maior do que a
variância devido às características dos imóveis.

Nos modelos onde houve a inclusão da variável Área Verde ($A_V$), seu
coeficiente foi bem estimado: o valor da influência das áreas verdes,
simulado como aumento R\$ 40,00/m2 a cada ponto percentual a mais de
áreas verdes no bairro do imóvel, foi precisamente estimado.

Para o modelo de Mundlak, a estimação do coeficiente contextual ($\beta_{1C}$)
também resultou significante, conforme esperado, já que os dados foram gerados
com áreas médias diferentes para cada bairro. 

Deve-se ponderar que, caso os dados não tivessem a estrutura esperada para a 
formulação adotada, haveria degeneração dos modelos. Por exemplo, caso não 
houvesse de fato variância alguma entre os bairros, ou seja, se o pertencimento
a um determinado agrupamento não afetar na formação final de preços, o valor
estimado para o desvio-padrão do efeito aleatório $\upsilon$ seria igual a zero, 
*i. e.* $\hat \sigma_\upsilon = 0$ [@Batesbook, 10-11] situação em que o
modelo misto degenera para um modelo de regressão linear ordinária. No caso da
formulação de Mundlak, caso não houvesse o efeito contextual, a variável de
contexto não apresentaria significância, ou seja, deveria ser removida do modelo,
fazendo com que o modelo degenere para um modelo misto simples.

Outra maneira de se testar a pertinência da formulação de Mundlak seria através
da Análise de Variância. A tabela \ref{tab:anova} faz a comparação entre o
modelo de efeitos mistos sem variáveis de segundo nível (primeira linha), com a
variável de segundo nível $A_V$ (segunda linha) e com a formulação de Mundlak
(terceira linha). Percebe-se que é significante a melhora advinda da adição de
um novo parâmetro no segundo modelo, assim como também é significante a adoção 
de um novo parâmetro pela formulação de Mundlak, o que se nota nos baixos 
p-valores constantes da última coluna (zero).

```{r anova}
kable(anova(fit_lmer, fit_lmer2, mundlak),
      caption = "Análise de Variância.", 
      digits = 2,
      format.args = list(big.mark = ".", decimal.mark = ","),
      booktabs = TRUE) %>%
  kable_styling(latex_options = "striped")
```

Por último, porém não menos relevante, percebe-se que este modelo tem
critérios de informação de Akaike (AIC) e de Bayes (BIC) melhores que os
dois modelos iniciais.

Nas Figuras \ref{fig:pr}, \ref{fig:pr1} e \ref{fig:pr2} podem ser vistos os
gráficos de densidades para os parâmetros estimados pelos modelos de efeitos
mistos simples, com variável de segundo nível e com formulação de Mundlak,
respectivamente. Nota-se que a ausência da variável de segundo nível levou o
modelo de efeitos mistos simples a uma má estimação da distribuição da variável
$\sigma_\upsilon$ (no gráfico $\sigma_1$), que apresentou uma longa cauda, com
valores possíveis entre aproximadamente 400 e 1400.

Com o acréscimo da variável de segundo nível esta variável ficou com magnitude
bem menor, ou seja, a introdução da variável de segundo nível reduziu a variação
não-explicada pelo modelo. Por fim, a introdução da variável contextual reduziu
ainda mais a variação não-explicada, gerando uma estimação precisa da variância
do termo aleatório $\sigma_\upsilon$.

```{r pr, fig.cap="Densidades dos parâmetros do modelo de efeitos mistos simples.", out.width="50%", fig.width=4}
densityplot(pr)
```

```{r pr1, fig.cap="Densidades dos parâmetros do modelo de efeitos mistos com variável de segundo nível.", out.width="75%"}
densityplot(pr1)
```
```{r pr2, fig.cap="Densidades dos parâmetros do modelo de Mundlak.", out.width="75%"}
densityplot(pr2)
```

## Previsão de Valores

Para ilustrar como os modelos mistos podem ser utilizados no contexto de
predição, foram elaboradas previsões no bairro H, que havia sido propositalmente
excluído no ajuste dos modelos mistos, com os diversos modelos apresentados.

Também foram utilizados o modelo de efeitos fixos e o modelo misto com a
variável de segundo nível $A_V$ para a previsão de valores de lote-padrão para
os diversos bairros, inclusive para o bairro H, não utilizado para a confecção
dos modelos mistos.

### Previsão de dados no bairro H

Na Figura \ref{fig:powerPlots} podem ser vistos os gráficos de poder de predição
para o modelo de efeitos fixos (A), para o modelo misto simples (B), para o 
modelo misto com a variável de segundo nível (C) e para o modelo misto com
formulação de Mundlak (D). Como pode ser visto, todos os modelos possuem poderes
de predição praticamente equivalentes, com exceção do modelo misto simples, onde
a previsão de valores não pode ser feita com precisão já que, como no modelo de
efeitos fixos, este modelo não tem parâmetros para prever valores em bairros não
contemplados na amostra. Para efetuar as previsões no bairro H, então, o modelo
considerou para a variável aleatória $\upsilon$ o valor zero, ou seja, o valor 
esperado da variável, o que levou a previsões incorretas em relação aos valores
simulados para aquele bairro.

```{r}
p1 <- predict(fit, newdata = newdata, interval = "prediction")
p2 <- predictInterval(fit_lmer, newdata = newdata, n.sims = 999, seed = seed)
p3 <- predictInterval(fit_lmer2, newdata = newdata, n.sims = 999, seed = seed)
p4 <- predictInterval(mundlak, newdata = newdata, n.sims = 999, seed = seed)
```

```{r}
fittedValues <- augment(fit)
pl_1 <- ggplot(data = fittedValues[which(fittedValues$Bairro == "H"), ], 
       aes(x = .fitted, y = ValorUnitario)) +
  geom_point() + 
  geom_abline(color="red") + 
  stat_smooth(method = "lm", se = FALSE) +
  coord_fixed(ratio = 1, 
              xlim = c(min(fittedValues$ValorUnitario[which(fittedValues$Bairro == "H")]), 
                       max(fittedValues$ValorUnitario[which(fittedValues$Bairro == "H")])), 
              ylim = NULL, expand = TRUE, clip = "on") +
  ylab("VU") +
  xlab(expression(~widehat(VU)))
```

```{r}
fitted_lmer <- data.frame(ValorUnitario = dados$ValorUnitario[which(dados$Bairro == "H")],
                          Bairro = "H",
                          .fitted = p2$fit)
```

```{r}
pl_2 <- ggplot(data = fitted_lmer, 
       aes(x = .fitted, y = ValorUnitario)) +
  geom_point() + 
  geom_abline(color="red") + 
  stat_smooth(method = "lm", se = FALSE) +
  coord_fixed(ratio = 1, 
              xlim = c(min(fitted_lmer$ValorUnitario), 
                       max(fitted_lmer$ValorUnitario)), 
              ylim = NULL, expand = TRUE, clip = "on") +
  ylab("VU") +
  xlab(expression(~widehat(VU)))
```

```{r}
fitted_lmer_2 <- data.frame(ValorUnitario = dados$ValorUnitario[which(dados$Bairro == "H")],
                          Bairro = "H",
                          .fitted = p3$fit)
```

```{r}
pl_3 <- ggplot(data = fitted_lmer_2, 
       aes(x = .fitted, y = ValorUnitario)) +
  geom_point() + 
  geom_abline(color="red") + 
  stat_smooth(method = "lm", se = FALSE) +
  coord_fixed(ratio = 1, 
              xlim = c(min(fitted_lmer$ValorUnitario), 
                       max(fitted_lmer$ValorUnitario)), 
              ylim = NULL, expand = TRUE, clip = "on") +
  ylab("VU") +
  xlab(expression(~widehat(VU)))
```

```{r}
fittedMundlak <- data.frame(ValorUnitario = dados$ValorUnitario[which(dados$Bairro == "H")],
                          Bairro = "H",
                          .fitted = p4$fit)
```

```{r}
pl_4 <- ggplot(data = fittedMundlak, 
       aes(x = .fitted, y = ValorUnitario)) +
  geom_point() + 
  geom_abline(color="red") + 
  stat_smooth(method = "lm", se = FALSE) +
  coord_fixed(ratio = 1, 
              xlim = c(min(fitted_lmer$ValorUnitario), 
                       max(fitted_lmer$ValorUnitario)), 
              ylim = NULL, expand = TRUE, clip = "on") +
  ylab("VU") +
  xlab(expression(~widehat(VU)))
```

```{r powerPlots, fig.cap = "Gráficos de poder de predição para cada modelo.", out.width="100%"}
plot_grid(pl_1 + theme(text = element_text(size=10),
        axis.text.x = element_text(angle=45, hjust=1)), 
          pl_2 + theme(text = element_text(size=10),
        axis.text.x = element_text(angle=45, hjust=1)),
          pl_3 + theme(text = element_text(size=10),
        axis.text.x = element_text(angle=45, hjust=1)),
          pl_4 + theme(text = element_text(size=10),
        axis.text.x = element_text(angle=45, hjust=1)), 
          labels = "AUTO", 
          label_size = 12)
```

### Previsão de valores para lotes-padrão

Assim como a previsão de valores para os dados simulados para o bairro
H, conforme se mostrou no item anterior, é possível prever valores para
um lote-padrão nos diferentes bairros.

A tabela abaixo mostra os valores previsto pelos modelos para um
lote-padrão de 400 $m^2$ nos diversos bairros:

```{r}
lote_padrao_A <- data.frame(Area = 400, Area_center = 0, AreaVerde = unique(dados$AreaVerde)[1],  Area_gm = unique(dados$Area_gm)[1], Area_dm = 400 - unique(dados$Area_gm)[1], Bairro = "A")
lote_padrao_B <- data.frame(Area = 400, Area_center = 0, AreaVerde = unique(dados$AreaVerde)[2],  Area_gm = unique(dados$Area_gm)[2], Area_dm = 400 - unique(dados$Area_gm)[2], Bairro = "B")
lote_padrao_C <- data.frame(Area = 400, Area_center = 0, AreaVerde = unique(dados$AreaVerde)[3],  Area_gm = unique(dados$Area_gm)[3], Area_dm = 400 - unique(dados$Area_gm)[3], Bairro = "C")
lote_padrao_D <- data.frame(Area = 400, Area_center = 0, AreaVerde = unique(dados$AreaVerde)[4],  Area_gm = unique(dados$Area_gm)[4], Area_dm = 400 - unique(dados$Area_gm)[4], Bairro = "D")
lote_padrao_E <- data.frame(Area = 400, Area_center = 0, AreaVerde = unique(dados$AreaVerde)[5],  Area_gm = unique(dados$Area_gm)[5], Area_dm = 400 - unique(dados$Area_gm)[5], Bairro = "E")
lote_padrao_F <- data.frame(Area = 400, Area_center = 0, AreaVerde = unique(dados$AreaVerde)[6],  Area_gm = unique(dados$Area_gm)[6], Area_dm = 400 - unique(dados$Area_gm)[6], Bairro = "F")
lote_padrao_G <- data.frame(Area = 400, Area_center = 0, AreaVerde = unique(dados$AreaVerde)[7],  Area_gm = unique(dados$Area_gm)[7], Area_dm = 400 - unique(dados$Area_gm)[7], Bairro = "G")
lote_padrao_H <- data.frame(Area = 400, Area_center = 0, AreaVerde = unique(dados$AreaVerde)[8],  Area_gm = unique(dados$Area_gm)[8], Area_dm = 400 - unique(dados$Area_gm)[8], Bairro = "H")
lote_padrao_I <- data.frame(Area = 400, Area_center = 0, AreaVerde = unique(dados$AreaVerde)[9],  Area_gm = unique(dados$Area_gm)[9], Area_dm = 400 - unique(dados$Area_gm)[9], Bairro = "I")
lote_padrao_J <- data.frame(Area = 400, Area_center = 0, AreaVerde = unique(dados$AreaVerde)[10], Area_gm = unique(dados$Area_gm)[10],Area_dm = 400 - unique(dados$Area_gm)[10],  Bairro = "J")
# EF Predsa <- predict(fit, newdata = lote_padrao_A)
a <- predict(fit, newdata = lote_padrao_A)
b <- predict(fit, newdata = lote_padrao_B)
c <- predict(fit, newdata = lote_padrao_C)
d <- predict(fit, newdata = lote_padrao_D)
e <- predict(fit, newdata = lote_padrao_E)
f <- predict(fit, newdata = lote_padrao_F)
g <- predict(fit, newdata = lote_padrao_G)
h <- predict(fit, newdata = lote_padrao_H)
i <- predict(fit, newdata = lote_padrao_I)
j <- predict(fit, newdata = lote_padrao_J)
# MixedModel Preds
a1 <- predict(fit_lmer2, newdata = lote_padrao_A)
b1 <- predict(fit_lmer2, newdata = lote_padrao_B)
c1 <- predict(fit_lmer2, newdata = lote_padrao_C)
d1 <- predict(fit_lmer2, newdata = lote_padrao_D)
e1 <- predict(fit_lmer2, newdata = lote_padrao_E)
f1 <- predict(fit_lmer2, newdata = lote_padrao_F)
g1 <- predict(fit_lmer2, newdata = lote_padrao_G)
h1 <- predictInterval(fit_lmer2, newdata = lote_padrao_H, seed = seed, which = 'all')$fit[1]
i1 <- predict(fit_lmer2, newdata = lote_padrao_I)
j1 <- predict(fit_lmer2, newdata = lote_padrao_J)
# Mundlak Preds
a2 <- predict(mundlak, newdata = lote_padrao_A)
b2 <- predict(mundlak, newdata = lote_padrao_B)
c2 <- predict(mundlak, newdata = lote_padrao_C)
d2 <- predict(mundlak, newdata = lote_padrao_D)
e2 <- predict(mundlak, newdata = lote_padrao_E)
f2 <- predict(mundlak, newdata = lote_padrao_F)
g2 <- predict(mundlak, newdata = lote_padrao_G)
h2 <- predictInterval(mundlak, newdata = lote_padrao_H, seed = seed, which = 'all')$fit[1]
i2 <- predict(mundlak, newdata = lote_padrao_I)
j2 <- predict(mundlak, newdata = lote_padrao_J)
```

| Bairro | Modelo de efeitos fixos                        | Modelo misto com variável de segundo nível  |  Modelo Mundlak  |
|:------:|:----------------------------------------------:|:---------------------------------------------:|:----------------:|
| A      | `r brf(a)`                                     | `r brf(a1)`                                   | `r brf(a2)`      |          
| B      | `r brf(b)`                                     | `r brf(b1)`                                   | `r brf(b2)`      |
| C      | `r brf(c)`                                     | `r brf(c1)`                                   | `r brf(c2)`      |
| D      | `r brf(d)`                                     | `r brf(d1)`                                   | `r brf(d2)`      |
| E      | `r brf(e)`                                     | `r brf(e1)`                                   | `r brf(e2)`      |
| F      | `r brf(f)`                                     | `r brf(f1)`                                   | `r brf(f2)`      |
| G      | `r brf(g)`                                     | `r brf(g1)`                                   | `r brf(g2)`      |
| H      | `r brf(h)`                                     | `r brf(h1)`                                   | `r brf(h2)`      |
| I      | `r brf(i)`                                     | `r brf(i1)`                                   | `r brf(i2)`      |
| J      | `r brf(j)`                                     | `r brf(j1)`                                   | `r brf(j2)`      |
Table: Previsões para valores de lote-padrão nos diferentes bairros.

### Intervalos de predição

No caso dos modelos mistos, os intervalos de predição são calculados
separadamente para cada efeito. Na tabela \ref{tab:pred1} podem ser
vistos os intervalos de predição (\@80\%) para o lote-padrão no bairro G.
A primeira linha mostra o intervalo total de predição combinado para os
dois efeitos. A segunda linha mostra o intervalo de predição para o
efeito aleatório (Bairro) e a terceira linha mostra o intervalo de
predição para o efeito fixo.

```{r}
fitted_G <- predictInterval(fit_lmer,
                            newdata = lote_padrao_G,
                            which = "all", 
                            seed = seed)
fitted_G$effect <- c("Combinados", "Bairro (aleatórios)", "Fixos")
```

```{r pred1}
kable(fitted_G,
      caption = "Previsão de valores para o lote padrão$^1$.",
      digits = 2,
      format.args = list(big.mark = ".", decimal.mark = ","),
      booktabs = TRUE,
      col.names = c("Efeitos", "Valor Central", "Limite Superior", "Limite Inferior", "Observações")) %>%
  kable_styling(latex_options = c("striped", "HOLD_position")) %>%
   footnote(number = "Para o bairro G, a partir do modelo misto simples.", 
            number_title = "Nota: ", footnote_as_chunk = T)
```

A tabela \ref{tab:pred2} mostra o intervalo de predição para o
lote-padrão no bairro H.

```{r}
fitted_H <- predictInterval(fit_lmer2,
                            newdata = lote_padrao_H,
                            which = "all",
                            seed = seed)
fitted_H$effect <- c("Combinados", "Bairro (aleatórios)", "Fixos")
```

```{r pred2}
kable(fitted_H,
      caption = "Previsão de valores para o lote padrão$^1$.",
      digits = 2,
      format.args = list(big.mark = ".", decimal.mark = ","),
      booktabs = TRUE,
      col.names = c("Efeitos", "Valor Central", "Limite Superior", "Limite Inferior", "Observações")) %>%
  kable_styling(latex_options = c("striped", "HOLD_position"))%>%
   footnote(number = "Para o bairro H, a partir do modelo misto com variável de 2º nível.",
            number_title = "Nota: ", footnote_as_chunk = T)
```

A tabela \ref{tab:pred3} mostra o intervalo de predição para o lote-padrão no
bairro H, obtido com o modelo de Mundlak.

```{r}
fitted_H_Mundlak <- predictInterval(mundlak,
                            newdata = lote_padrao_H,
                            which = "all",
                            seed = seed)
fitted_H_Mundlak$effect <- c("Combinados", "Bairro (aleatórios)", "Fixos")
```

```{r pred3}
kable(fitted_H_Mundlak,
      caption = "Previsão de valores para o lote padrão$^1$.",
      digits = 2,
      format.args = list(big.mark = ".", decimal.mark = ","),
      booktabs = TRUE,
      col.names = c("Efeitos", "Valor Central", "Limite Superior", "Limite Inferior", "Observações")) %>%
  kable_styling(latex_options = c("striped", "HOLD_position")) %>%
   footnote(number = "Para o bairro H, a partir do modelo com formulação de Mundlak.",
            number_title = "Nota: ", footnote_as_chunk = T)
```

Para efeitos de comparação, a tabela \ref{tab:pred4} mostra o intervalo
de predição para o bairro H calculado com o modelo de efeitos fixos.

```{r}
p <- as.data.frame(predict(fit, lote_padrao_H, interval = "prediction", level = 0.80))
p$Efeito <- "Fixos"
p <- p[, c(4, 1, 3, 2)]
```

```{r pred4}
kable(p,
      caption = "Previsão de valores para o lote padrão$^1$",
      digits = 2,
      format.args = list(big.mark = ".", decimal.mark = ","),
      booktabs = TRUE,
      col.names = c("Efeitos", "Valor Central", "Limite Superior", "Limite Inferior")) %>%
  kable_styling(latex_options = c("striped", "HOLD_position")) %>% 
  footnote(number = "Para o bairro H, a partir do modelo de efeitos fixos.",
            number_title = "Nota: ", footnote_as_chunk = T)
```

Nota-se que os intervalos de predição do modelo de efeitos fixos apresentados na
tabela \ref{tab:pred4} e o intervalo de predição total combinado do modelo com
formulação de Mundlak (linha 1 da tabela \ref{tab:pred3}) praticamente se
equivalem. Deve-se lembrar, porém, que para o modelo de efeitos fixos foram
utilizados 10\% mais dados e que o modelo de efeitos mistos não utilizou
qualquer dado amostral proveninente do bairro H.

# Conclusão

A aplicação da modelagem mista ou hierárquica na Engenharia de Avaliações pode
ser feita das mais diversas maneiras, desde a aplicação em avaliações de
precisão, até a avaliação em massa para fins tributários, assim como para
confecção de índices de preços de imóveis.

Neste trabalho foi mostrado como a Engenharia de Avaliações pode se valer da
modelagem hierárquica ou mista para a confecção de PVG's, com a utilização de
modelos com interceptos aleatórios, especialmente para estimação de valores para
lotes-padrão em agrupamentos não presentes na amostra, através da utilização de
variáveis de segundo nível que *expliquem* a variabilidade entre os bairros
ou outros agrupamentos. Tais modelos são mais complexos e ao mesmo tempo
elegantes, dividindo a variabilidade em diversos níveis, deixando claro ao
analista de onde advém a variabilidade dos preços.

Embora a modelagem hierárquica seja considerada mais elegante do que a modelagem
de efeitos fixos, deve-se ter em conta que a elaboração de modelos mistos sem
variáveis de segundo nível, como é comum encontrar na literatura, não é tão
interessante e quase nada agrega a uma melhor explicação do fenômeno estudado.
Deve até haver uma melhora na estimação com os modelos mistos caso os dados de
alguns agrupamentos estejam em número reduzido, mas o ideal é utilizar as
formulações mais complexas da modelagem hierárquica de maneira a explorar ao
máximo este tipo de modelagem.

Na análise de dados em seção transversal, como na elaboração de avaliações de
precisão ou na elaboração de PVG's, deve ser utilizada, preferencialmente, a
formulação de Mundlak, enquanto para dados em painel, como na confecção de
índices de preços de imóveis, deve ser preferencialmente utilizada a formulação
REWB.

Na modelagem hierárquica ainda é possível incorporar outras hipóteses úteis,
além dos interceptos aleatórios, como as inclinações aleatórias, o que deve
ser tema de outro trabalho.

Outra possibilidade é a modelagem em mais níveis hierárquicos: não apenas os
imóveis podem ser agrupados em bairros, mas também os bairros podem, por sua
vez, serem agrupados em macrozonas urbanas, assim como estas podem ser agrupadas
em cidades, estas, por sua vez, em regiões e assim por diante. O ajuste de 
modelos tão complexos com efeitos fixos é inviável.

# Referências {-}
