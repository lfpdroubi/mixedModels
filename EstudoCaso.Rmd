---
title: "Modelos hierárquicos na Engenharia de Avaliações"
subtitle: "Para confecção de PVG's e índices de mercado"
author: 
  - "Luiz F. P. Droubi"
  - "Carlos Augusto Zilli"
  - "Norberto Hoccheim"
date: "`r format(Sys.Date(), '%d/%m/%Y')`"
output:
  pdf_document:
    includes:
      in_header: preamble.tex
    keep_tex: yes
    latex_engine: xelatex
    number_sections: yes
    toc: no
  word_document: default
  html_document:
    fig_caption: yes
    keep_md: yes
classoption: a4paper, 12pt
documentclass: article
geometry: left=2.5cm,right=2.0cm,top=1.5cm,bottom=1.5cm
link-citations: yes
linkcolor: red
urlcolor: magenta
citecolor: green
csl: ABNT_UFPR_2011-Mendeley.csl
bibliography: bibliography.bib
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      out.width = "70%", fig.align = "center", fig.pos = "H")
type <- knitr::opts_knit$get("rmarkdown.pandoc.to")
library(appraiseR)
library(nlme)
library(lme4)
library(performance)
library(merTools)
library(lattice)
library(corrplot)
#library(sjPlot)
library(lfe)
library(tidyverse)
library(ggplot2)
library(stargazer)
library(cowplot)
library(broom)
library(broom.mixed)
library(parameters)
library(knitr)
library(kableExtra)
theme_set(theme_cowplot())
```

# Introdução

# Revisão Bibliográfica

# Estudo de Caso

## Criação de dados via simulação

```{r}
# Simulação de dados
set.seed(1)
# Dados por bairro
a <- 50
# Número de bairros
b <- 11
# Variáveis de nível 1
#
# Área
#
A <- rnorm(a*b, mean = 400, sd = 50)
#
# Variáveis de nível 2
#
# Área livre
AL <- rep(seq(.2, .7, .05), each = a)
#
# Equação de segundo nível
#
beta_zero <- 2000
beta_zeroj <- beta_zero + 3000*AL + rnorm(b*a, mean = 0, sd = 50)
#
# Equação mista
#
VU <- beta_zeroj - 3*A + rnorm(b*a, mean = 0, sd = 100)
```

Foram criados `r a*b` dados de lotes, divididos igualmente em `r b` bairros, 
a partir de simulação com o auxílio do software **R**.

Os dados foram criados conforme parâmetros da tabela 1:

| Variável              | Tipo          | Distribuição | Parâmetros                      | Obs                       |
|:----------------------|--------------:|:------------:|--------------------------------:|:-------------------------:|
| Área ($A$)            | Quantitativa  | Normal       | $\mu = 400, \sigma = 50$        |  -                        |
| Bairro                | Qualitativa   | -            | A a K                           |  -                        |
| Áreas Verdes ($A_V$)  | Quantitativa  | Uniforme     | $\mu = 0,2 \quad a \quad 0,70$  |Um valor para cada bairro  |
| $\beta_{0}$           | Coeficiente   | Discreta     | 2000                            |  -                        |
| $\upsilon$            | Termo de erro | Normal       | $\mu = 0, \sigma = 150$         |  -                        |
| $\beta_{0j}$          | Coeficiente   | Não definida | $\beta_0 + 3000A_V + \upsilon$  |  -                        |
| $\epsilon$            | Termo de erro | Normal       | $\mu = 0, \sigma = 50$          |  -                        |
| Valor Unitário ($VU$) | Quantitativa  | Não definida | $\beta_{0j} - 3,0 A + \epsilon$ |  -                        | 


```{r}
dados <- tibble(Area = A,
                AreaLivre = AL,
                Bairro = factor(rep(LETTERS[1:b], each=a)),
                ValorUnitario = VU
                )
dados <- as_tibble(dados)
```

## Análise exploratória dos dados

```{r}
p1 <- ggplot(dados, aes(x = Bairro, y = ValorUnitario, color = Bairro)) +
        geom_boxplot() + 
        geom_smooth(method = "lm", se = FALSE)
```

```{r}
p2 <- ggplot(dados, aes(x = Area, y = ValorUnitario, color = Bairro)) +
        geom_point() + 
        geom_smooth(method = "lm", se = FALSE)
```

```{r}
p3 <- ggplot(dados, aes(x = Bairro, y = AreaLivre, color = Bairro)) +
        geom_bar(stat = "identity")
```

```{r}
p4 <- ggplot(dados, aes(ValorUnitario, fill = Bairro)) + 
  geom_density(alpha = 0.5) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.05))) +
  theme_minimal_hgrid(12)
```

Na figura \ref{fig:exploratoria} é possível ver os principais gráficos dos dados
gerados.

```{r exploratoria, fig.cap = "Análise exploratória dos dados.", out.width="100%"}
plot_grid(p1 + theme(legend.position="none"), 
          p2 + theme(legend.position="none"),
          p3 + theme(legend.position="none"),
          p4 + theme(legend.position="none"), 
          labels = "AUTO", 
          label_size = 12)
```
## Ajuste de modelos

Com os dados gerados foram ajustados um modelo de efeitos fixos e três
modelos mistos: um modelo misto simples, que praticamente equivale ao modelo de
efeitos fixos, um modelo misto com a adição de uma variável de segundo nível e 
um modelo misto utilizando-se a formulação de Mundlak.

Para o ajuste do modelo de efeitos fixos foram utilizados todos os dados gerados,
pois não há como prever valores para bairros não contemplados na amostra em um
modelo deste tipo.

Para o ajuste dos modelos mistos foram removidos os 50 dados relativos ao bairro
H, que foram reservados para serem utilizados posteriormente para validação dos
modelos, mostrando como a previsão de valores em modelos de efeitos mistos pode
ser feita para agrupamentos não contemplados na amostra.

```{r}
dados <- cbind(
        dados,
        demean(dados, select = "Area", group = "Bairro")
)
dados <- as.tibble(dados)
amostra <- dados[which(dados$Bairro != "H"), ]
newdata <- dados[which(dados$Bairro == "H"), ]
```


### Modelo de efeitos fixos

Com os dados gerados, foi elaborado um modelo de efeitos fixos, do tipo:

$$ValorUnitario = \beta_0 + \beta_1Area + \beta_{2i}Bairro_i + \epsilon$$
onde $\beta_{2i}$ são os coeficientes das variáveis dicotômicas em grupo ($Bairro_i$).

```{r}
fit <- lm(ValorUnitario ~ Area + Bairro - 1, data = dados)
fit$AIC <- AIC(fit)
fit$BIC <- BIC(fit)
fit$LL <- logLik(fit)
```

### Modelo misto simples

Também foi elaborado um modelo misto do tipo:

$$ValorUnitario = \beta_0 + \beta_1Area + \upsilon_i + \epsilon$$
Onde $\upsilon_i$ é uma variável aleatória que foi utilizada para modelar os
diferentes bairros.


```{r}
fit_lmer <- lmer(ValorUnitario ~ Area + (1|Bairro), data = amostra, REML = FALSE)
s <- summary(fit_lmer)
```

```{r}
re <- ranef(fit_lmer)
fe <- fixef(fit_lmer)
pr1 <- profile(fit_lmer)
```

Os efeitos aleatórios do modelo misto simples podem ser visualizados na 
Figura \ref{fig:dotplot}.

Como se pode notar na Figura \ref{fig:dotplot}, os valores dos interceptos
aleatórios para cada bairro giram em torno de zero, o seu valor médio. Como o 
Bairro H (com $A_L = 0,55$) foi omitido no ajusto do modelo, não há valores
estimados para os efeitos aleatórios para este bairro.

```{r dotplot, fig.cap="Efeitos aleatórios do modelo.", results='hide'}
dotplot(ranef(fit_lmer))
```

Os valores de referência para cada bairro podem ser obtidos através da soma do
intercepto global do modelo misto simples com os interceptos aleatórios, o que 
pode ser visto na tabela \ref{tab:somaitcpt}.

```{r somaitcpt}
kable(t(re$Bairro + fe[1]), 
      digits = 1,
      format.args = list(big.mark = ".", decimal.mark = ","),
      caption = "Valores dos interceptos para cada bairro.",
      booktabs = TRUE) %>%
  kable_styling(font_size = 10)
```

Como se pode perceber, quase não houve diferença entre os valores estimados em 
cada modelo.

A ínica informação a mais que se pode extrair do modelo de efeitos mistos é
a componente de variância devido à localidade, separada da variância ao nível 
dos imóveis, o que pode ser visto na tabela \ref{tab:variancias}. 

```{r variancias}
vc <- VarCorr(fit_lmer)
vc <- as.data.frame(vc)
## both variance and std.dev.
#print(vc,comp=c("Variance","Std.Dev."), digits = 2)
## variance only
#print(vc,comp=c("Variance"))
#as.data.frame(vc)
#as.data.frame(vc,order="lower.tri")
# kable(tidy(fit_lmer, effects = "ran_pars"), digits = 2, 
#       format.args = list(big.mark = ".", decimal.mark = ","),
#       caption = "Efeitos randômicos do modelo misto.", booktabs = T) %>%
#   kable_styling(latex_options = "striped")
kable(vc[, -2:-3], digits = 2,
      format.args = list(big.mark = ".", decimal.mark = ","),
      caption = "Efeitos randômicos do modelo misto.", booktabs = T) %>%
  kable_styling(latex_options = "striped")
```

Pode-se notar que a variância devido à localidade é relevante para o modelo, haja
vista que a variância devido à localidade é maior do que a variância devido às
características dos imóveis.

### Modelo misto com variáveis de segundo nível

Finalmente, foi elaborado um modelo misto do tipo:

$$ValorUnitario = \beta_0 + \beta_1Area + \beta_2 A_V+ \upsilon_i + \epsilon$$

Onde $A_V$ é uma variável de nível 2 que representa a porcentagem de áreas 
verdes em cada bairro, em relação à área total.

```{r}
fit_lmer2 <- lmer(ValorUnitario ~ Area + AreaLivre + (1|Bairro), data = amostra)
s2 <- summary(fit_lmer2)
```

### Modelo misto com formulação de Mundlak

Finalmente, foi ajusta um modelo com a formulação de Mundlak. Este modelo foi
elaborado de acordo com a seguinte formulação:

$$ValorUnitario = \beta_0 + \beta_1 Area + \beta_{1C} \overline{Area}+ \beta_2 A_V+ \upsilon_i + \epsilon$$

```{r}
mundlak <- 
        lmer(ValorUnitario ~ Area + Area_between + AreaLivre + (1|Bairro),
  data = amostra,
  REML = TRUE)
s3 <- summary(mundlak)
```

## Resultados

A tabela \ref{tab:fits} mostra as estatísticas básicas dos diversos modelos 
mistos (colunas (2), (3) e (4)) comparados aos modelo de efeitos fixos (coluna 
(1)).

Como pode ser vistos nesta tabela, o valor do intercepto global (a dita grande 
média) foi melhor estimada (comparando-se com o valor simulado) pelo modelo 
misto com a variável de segundo nível $A_L$, obtendo um resultado de 
R\$ `r brf(s2$coefficients[1])`. Isto ocorre porque o efeito da variável 
relevante $A_V$ não inclusa no modelo anterior havia sido absorvida por este 
coeficiente.

Nos modelos onde houve a inclusão da variável Área Livre ($A_L$), seu
coeficiente foi bem estimado: o valor da influência das áreas verdes, simulado 
como aumento R\$ 30,00/m2 a cada ponto percentual a mais de áreas verdes no 
bairro do imóvel, foi precisamente estimado. 

Para o modelo de Mundlak, a estimação do coeficiente contextual ($\beta_{1C}$)
foi insignificante. Isto era esperado, dado que a variável Área foi simulada
da mesma maneira para todos os bairros. Em outras palavras, a simulação foi feita
como se os imóveis em todos os bairros tivessem a mesma distribuição (normal) com
mesma média e desvio-padrão. Isto dificilmente ocorrerá na prática da elaboração
de PVG's, mas é interessante notar a flexibilidade deste tipo de formulação: 
quando não existe na realidade o efeito esperado pela formulação, o coeficiente
resultará insignificante. Diz-se em estatística que o modelo degenerou, ou seja,
o modelo com a formulação de Mundlak se degenerou para uma formulação mais 
simples. Basta remover este termo da modelagem para obter-se o modelo mais 
correto para o caso. Portanto, na prática, deve-se partir da formulação mais
complexa, no caso a de Mundlak, e observar se os resultados obtidos são 
significantes. Caso positivo, mantem-se o modelo. Caso contrário, descarta-se
o termo insignificante.

Por último, porém não menos relevante, percebe-se que este modelo tem critérios
de informação de Akaike (AIC) e de Bayes (BIC) melhores que os dois modelos 
iniciais.

```{r fits, results='asis'}
stargazer(fit, fit_lmer, fit_lmer2, mundlak, header = FALSE, label = "tab:fits", 
          type = type, decimal.mark = ",", digit.separator = ".", digits = 2,
          title = "Comparacão dos modelos de  efeitos fixos e efeitos mistos.",
          intercept.bottom = FALSE, intercept.top = TRUE, report = "vcs*", 
          single.row = TRUE, star.cutoffs = c(0.30, 0.20, 0.10),
          omit.stat = "adj.rsq", table.placement = "H", font.size = "scriptsize")
```



## Previsão de Valores

Na Figura \ref{fig:powerPlots} podem ser vistos os gráficos de poder de predição
para o modelo de efeitos fixos (A), para o modelo misto simples (B), para o 
modelo misto com a variável de segundo nível (C) e para o modelo misto com
formulação de Mundlak (D). Como pode ser visto, todos os modelos possuem poderes
de predição praticamente equivalentes, com exceção do modelo misto simples, onde
a previsão de valores não pode ser feita com precisão já que, como no modelo de
efeitos fixos, este modelo não tem parâmetros para prever valores em bairros não
contemplados na amostra. Para efetuar as previsões no bairro H, então, o modelo
considerou para a variável aleatória $\upsilon$ o valor zero, ou seja, o valor 
esperado da variável, o que levou a previsões incorretas em relação aos valores
simulados para aquele bairro.

```{r}
p1 <- predict(fit, newdata = newdata, interval = "prediction")
p2 <- predictInterval(fit_lmer, newdata = newdata, n.sims = 999)
p3 <- predictInterval(fit_lmer2, newdata = newdata, n.sims = 999)
p4 <- predictInterval(mundlak, newdata = newdata, n.sims = 999)
```

```{r}
fittedValues <- augment(fit)
pl_1 <- ggplot(data = fittedValues[which(fittedValues$Bairro == "H"), ], 
       aes(x = .fitted, y = ValorUnitario)) +
  geom_point() + 
  geom_abline(color="red") + 
  stat_smooth(method = "lm", se = FALSE) +
  coord_fixed(ratio = 1, 
              xlim = c(min(fittedValues$ValorUnitario[which(fittedValues$Bairro == "H")]), 
                       max(fittedValues$ValorUnitario[which(fittedValues$Bairro == "H")])), 
              ylim = NULL, expand = TRUE, clip = "on")
```

```{r}
fitted_lmer <- data.frame(ValorUnitario = dados$ValorUnitario[which(dados$Bairro == "H")],
                          Bairro = "H",
                          .fitted = p2$fit)
```

```{r}
pl_2 <- ggplot(data = fitted_lmer, 
       aes(x = .fitted, y = ValorUnitario)) +
  geom_point() + 
  geom_abline(color="red") + 
  stat_smooth(method = "lm", se = FALSE) +
  coord_fixed(ratio = 1, 
              xlim = c(min(fitted_lmer$ValorUnitario), 
                       max(fitted_lmer$ValorUnitario)), 
              ylim = NULL, expand = TRUE, clip = "on")
```

```{r}
fitted_lmer_2 <- data.frame(ValorUnitario = dados$ValorUnitario[which(dados$Bairro == "H")],
                          Bairro = "H",
                          .fitted = p3$fit)
```

```{r}
pl_3 <- ggplot(data = fitted_lmer_2, 
       aes(x = .fitted, y = ValorUnitario)) +
  geom_point() + 
  geom_abline(color="red") + 
  stat_smooth(method = "lm", se = FALSE) +
  coord_fixed(ratio = 1, 
              xlim = c(min(fitted_lmer$ValorUnitario), 
                       max(fitted_lmer$ValorUnitario)), 
              ylim = NULL, expand = TRUE, clip = "on")
```

```{r}
fittedMundlak <- data.frame(ValorUnitario = dados$ValorUnitario[which(dados$Bairro == "H")],
                          Bairro = "H",
                          .fitted = p4$fit)
```

```{r}
pl_4 <- ggplot(data = fittedMundlak, 
       aes(x = .fitted, y = ValorUnitario)) +
  geom_point() + 
  geom_abline(color="red") + 
  stat_smooth(method = "lm", se = FALSE) +
  coord_fixed(ratio = 1, 
              xlim = c(min(fitted_lmer$ValorUnitario), 
                       max(fitted_lmer$ValorUnitario)), 
              ylim = NULL, expand = TRUE, clip = "on")
```

```{r powerPlots, fig.cap = "Gráficos de poder de predição para cada modelo.", out.width="100%"}
plot_grid(pl_1 + theme(text = element_text(size=10),
        axis.text.x = element_text(angle=45, hjust=1)), 
          pl_2 + theme(text = element_text(size=10),
        axis.text.x = element_text(angle=45, hjust=1)),
          pl_3 + theme(text = element_text(size=10),
        axis.text.x = element_text(angle=45, hjust=1)),
          pl_4 + theme(text = element_text(size=10),
        axis.text.x = element_text(angle=45, hjust=1)), 
          labels = "AUTO", 
          label_size = 12)
```


